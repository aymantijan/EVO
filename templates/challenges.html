{% extends 'base.html' %}
{% load static %}

{% block title %}Challenges Quotidien & IA - Vision 2052{% endblock %}

{% block extra_css %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    :root {
        --primary-color: #06b6d4;
        --primary-hover: #0891b2;
        --success-color: #10b981;
        --danger-color: #ef4444;
        --warning-color: #f59e0b;
        --bg-primary: #ffffff;
        --bg-secondary: #f9fafb;
        --text-primary: #111827;
        --text-secondary: #6b7280;
        --border-color: #e5e7eb;
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
    }

    .vision-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem 1.5rem;
    }

    .vision-header {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid var(--border-color);
    }

    .vision-header h1 {
        font-size: 2.25rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
    }

    .vision-subtitle {
        font-size: 0.95rem;
        color: var(--text-secondary);
        opacity: 0.8;
    }

    .vision-stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1.25rem;
        margin-bottom: 2.5rem;
    }

    .vision-stat-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1.5rem;
        text-align: center;
        transition: all 200ms ease;
        box-shadow: var(--shadow-sm);
    }

    .vision-stat-card:hover {
        border-color: rgba(33, 128, 141, 1);
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .vision-stat-value {
        font-size: 2.25rem;
        font-weight: 800;
        color: rgba(33, 128, 141, 1);
        margin-bottom: 0.5rem;
    }

    .vision-stat-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .vision-tabs {
        display: flex;
        gap: 0;
        margin-bottom: 2rem;
        border-bottom: 2px solid var(--border-color);
        overflow-x: auto;
    }

    .vision-tabs::-webkit-scrollbar {
        height: 4px;
    }

    .vision-tabs::-webkit-scrollbar-thumb {
        background: rgba(33, 128, 141, 1);
        border-radius: 2px;
    }

    .vision-tab-btn {
        padding: 1rem 1.75rem;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--text-secondary);
        border-bottom: 3px solid transparent;
        transition: all 200ms ease;
        margin-bottom: -2px;
        white-space: nowrap;
    }

    .vision-tab-btn:hover {
        color: var(--text-primary);
        background: rgba(6, 182, 212, 0.05);
    }

    .vision-tab-btn.active {
        color: rgba(33, 128, 141, 1);
        border-bottom-color: rgba(33, 128, 141, 1);
    }

    .vision-tab-content {
        display: none;
        animation: fadeIn 300ms ease;
    }

    .vision-tab-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .vision-daily-table {
        display: grid;
        gap: 1rem;
    }

    .vision-task-row {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1.25rem;
        display: grid;
        grid-template-columns: 60px 180px 1fr auto;
        gap: 1rem;
        align-items: center;
        transition: all 200ms ease;
        box-shadow: var(--shadow-sm);
    }

    .vision-task-row:hover {
        border-color: rgba(33, 128, 141, 1);
        box-shadow: var(--shadow-md);
        background: rgba(6, 182, 212, 0.02);
    }

    .vision-task-emoji {
        font-size: 2rem;
        text-align: center;
    }

    .vision-task-name {
        font-weight: 700;
        font-size: 1rem;
        color: var(--text-primary);
    }

    .vision-task-inputs {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .vision-task-input,
    .vision-task-select {
        padding: 0.6rem 0.875rem;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-family: inherit;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        transition: all 150ms ease;
    }

    .vision-task-input:focus,
    .vision-task-select:focus {
        outline: none;
        border-color: rgba(33, 128, 141, 1);
        box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        background-color: rgba(6, 182, 212, 0.02);
    }

    .vision-task-input {
        width: 90px;
    }

    .vision-task-select {
        min-width: 150px;
    }

    .time-input-group {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        font-weight: 600;
        color: var(--text-secondary);
    }

    /* NEW: Specific styling for sleep time inputs */
    .sleep-time-inputs {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .sleep-time-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-secondary);
    }

    .sleep-time-input {
        padding: 0.6rem 0.875rem;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-family: inherit;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        width: 80px;
    }

    .sleep-time-input:focus {
        outline: none;
        border-color: rgba(33, 128, 141, 1);
        box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        background-color: rgba(6, 182, 212, 0.02);
    }

    .hp-calc-display {
        font-size: 0.85rem;
        color: var(--success-color);
        font-weight: 700;
        padding: 0.5rem 1rem;
        background: rgba(16, 185, 129, 0.1);
        border-radius: 0.5rem;
        border: 1px solid rgba(16, 185, 129, 0.3);
        white-space: nowrap;
        transition: all 200ms ease;
    }

    .hp-calc-display.negative {
        color: var(--danger-color);
        background: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.3);
    }

    .quotidien-action-bar {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        flex-wrap: wrap;
    }

    .vision-btn {
        padding: 0.875rem 1.75rem;
        border: none;
        border-radius: 0.5rem;
        font-weight: 700;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 200ms ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .vision-btn-primary {
        background: rgba(33, 128, 141, 1);
        color: white;
    }

    .vision-btn-primary:hover {
        background: rgba(6, 182, 212, 1);
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .vision-btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    .vision-btn-secondary:hover {
        background: #e5e7eb;
        box-shadow: var(--shadow-sm);
    }

    .vision-btn-success {
        background: var(--success-color);
        color: white;
        flex: 1;
    }

    .vision-btn-success:hover {
        background: #059669;
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .ia-section {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 2rem;
        box-shadow: var(--shadow-sm);
    }

    .ia-section h3 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
    }

    .ia-section-subtitle {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 1.5rem;
        line-height: 1.6;
    }

    .ia-textarea {
        width: 100%;
        min-height: 180px;
        padding: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        font-size: 0.9rem;
        font-family: inherit;
        resize: vertical;
        margin-bottom: 1.5rem;
        transition: all 150ms ease;
    }

    .ia-textarea:focus {
        outline: none;
        border-color: rgba(33, 128, 141, 1);
        box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        background-color: rgba(6, 182, 212, 0.02);
    }

    .ia-action-bar {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .ia-results {
        margin-top: 2rem;
        display: none;
    }

    .ia-results.active {
        display: block;
    }

    .ia-result-section {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }

    .ia-result-title {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: var(--text-primary);
    }

    .xp-hp-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .xp-hp-card {
        background: white;
        padding: 1.25rem;
        border-radius: 0.5rem;
        text-align: center;
        border: 2px solid;
    }

    .xp-hp-card.xp {
        border-color: rgba(33, 128, 141, 1);
        background: rgba(6, 182, 212, 0.05);
    }

    .xp-hp-card.hp {
        border-color: var(--success-color);
        background: rgba(16, 185, 129, 0.05);
    }

    .xp-hp-label {
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
    }

    .xp-hp-value {
        font-size: 2rem;
        font-weight: 800;
    }

    .xp-hp-card.xp .xp-hp-value {
        color: rgba(33, 128, 141, 1);
    }

    .xp-hp-card.hp .xp-hp-value {
        color: var(--success-color);
    }

    .detections-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .detection-card {
        background: white;
        padding: 1rem;
        border-radius: 0.5rem;
        text-align: center;
        border: 1px solid var(--border-color);
        transition: all 150ms ease;
    }

    .detection-card:hover {
        border-color: rgba(33, 128, 141, 1);
        box-shadow: var(--shadow-sm);
    }

    .detection-emoji {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .detection-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .detection-value {
        font-size: 1.25rem;
        font-weight: 800;
        color: rgba(33, 128, 141, 1);
    }

    .trait-detection-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .trait-detection-item {
        background: white;
        padding: 1rem;
        border-radius: 0.5rem;
        border: 1px solid var(--border-color);
        transition: all 150ms ease;
    }

    .trait-detection-item:hover {
        border-color: rgba(33, 128, 141, 1);
        box-shadow: var(--shadow-sm);
    }

    .trait-detection-item.negative {
        border-color: var(--danger-color);
        background: rgba(239, 68, 68, 0.02);
    }

    .trait-name {
        font-weight: 700;
        font-size: 0.95rem;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .trait-values {
        display: flex;
        gap: 1rem;
        margin-top: 0.75rem;
    }

    .trait-value {
        font-size: 0.9rem;
        font-weight: 700;
        padding: 0.4rem 0.75rem;
        border-radius: 0.375rem;
    }

    .trait-value.hp {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success-color);
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .trait-detection-item.negative .trait-value.hp {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger-color);
        border-color: rgba(239, 68, 68, 0.3);
    }

    .loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 3rem;
        color: var(--text-secondary);
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--border-color);
        border-top-color: rgba(33, 128, 141, 1);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .alert-message {
        margin-top: 1.5rem;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        display: none;
        transition: all 200ms ease;
    }

    .alert-message.show {
        display: block;
        animation: slideDown 300ms ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .alert-message.success {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
        color: var(--success-color);
    }

    .alert-message.error {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: var(--danger-color);
    }

    .alert-message.info {
        background: rgba(6, 182, 212, 0.1);
        border: 1px solid rgba(6, 182, 212, 0.3);
        color: rgba(33, 128, 141, 1);
    }

    @media (max-width: 1024px) {
        .vision-task-row {
            grid-template-columns: 50px 150px 1fr;
        }

        .vision-stats-overview {
            grid-template-columns: repeat(2, 1fr);
        }

        .trait-detection-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .vision-container {
            padding: 1.5rem 1rem;
        }

        .vision-header h1 {
            font-size: 1.75rem;
        }

        .vision-task-row {
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }

        .vision-task-emoji {
            font-size: 1.5rem;
        }

        .vision-task-inputs {
            width: 100%;
        }

        .vision-stats-overview {
            grid-template-columns: 1fr;
        }

        .ia-section {
            padding: 1.5rem 1rem;
        }

        .trait-detection-grid {
            grid-template-columns: 1fr;
        }

        .vision-btn {
            flex: 1;
            justify-content: center;
        }

        .ia-action-bar {
            flex-direction: column;
        }

        .vision-tabs {
            flex-wrap: nowrap;
            overflow-x: auto;
        }

        .xp-hp-grid {
            grid-template-columns: 1fr;
        }

        .detections-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 480px) {
        .vision-header h1 {
            font-size: 1.5rem;
        }

        .vision-stat-card {
            padding: 1rem;
        }

        .vision-stat-value {
            font-size: 1.75rem;
        }

        .ia-textarea {
            min-height: 140px;
        }

        .vision-task-row {
            padding: 1rem;
        }

        .detections-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="vision-container">
    <!-- HEADER -->
    <div class="vision-header">
        <h1>üéØ Challenges Quotidien & √âvaluateur IA</h1>
        <p class="vision-subtitle">Quotidien: 10 activit√©s HP traits | IA: D√©tection XP + HP + Artefacts</p>
    </div>

    <!-- STATS OVERVIEW -->
<div class="vision-stats-overview">
    <div class="vision-stat-card">
        <div class="vision-stat-value" data-stat="xp">0</div>
        <div class="vision-stat-label">Total XP</div>
    </div>
    <div class="vision-stat-card">
        <div class="vision-stat-value" data-stat="hp">0</div>
        <div class="vision-stat-label">Total HP</div>
    </div>
    <div class="vision-stat-card">
        <div class="vision-stat-value" data-stat="traits">0</div>
        <div class="vision-stat-label">Traits Actifs</div>
    </div>
    <div class="vision-stat-card">
        <div class="vision-stat-value" data-stat="level">1</div>
        <div class="vision-stat-label">Niveau</div>
    </div>
</div>


    <!-- TABS -->
    <div class="vision-tabs">
        <button class="vision-tab-btn active" onclick="switchTab(event, 'daily')">
            üìä Quotidien (10 Activit√©s)
        </button>
        <button class="vision-tab-btn" onclick="switchTab(event, 'ia')">
            ü§ñ √âvaluateur IA (76 Traits + Artefacts)
        </button>
    </div>

    <!-- TAB 1: QUOTIDIEN -->
    <div id="daily" class="vision-tab-content active">
        <div style="margin-bottom: 1.5rem;">
            <p class="vision-subtitle">Enregistrez vos activit√©s quotidiennes pour gagner des HP et d√©velopper vos traits de personnalit√©.</p>
        </div>

        <div class="vision-daily-table" id="dailyTasksTable"></div>

        <div class="quotidien-action-bar">
            <button class="vision-btn vision-btn-primary" onclick="submitDaily()">
                üíæ Enregistrer Activit√©s
            </button>
            <button class="vision-btn vision-btn-secondary" onclick="clearAllDaily()">
                üîÑ R√©initialiser
            </button>
        </div>

        <div id="dailyAlert" class="alert-message"></div>
    </div>

    <!-- TAB 2: √âVALUATEUR IA -->
    <div id="ia" class="vision-tab-content">
        <div class="ia-section">
            <h3>ü§ñ √âvaluateur IA - D√©tection Compl√®te</h3>
            <p class="ia-section-subtitle">
                D√©crivez en d√©tail votre activit√©. Le syst√®me d√©tectera automatiquement:
                <br>‚úì XP complet | ‚úì 76 Traits HP | ‚úì 6 Artefacts
            </p>

            <textarea
                class="ia-textarea"
                id="iaDescription"
                placeholder="Exemple: Jai men√© une analyse de 2000 r√©ponses de sondage, cr√©√© 15 dashboards Excel avec des pivot tables complexes, identifi√© 8 segments de consommateurs. Jai lu 3 articles acad√©miques sur le comportement des consommateurs et suivi un cours en ligne sur data analysis. Jai pr√©sent√© les r√©sultats et contribu√© √† un projet GitHub open-source...">
            </textarea>

            <div class="ia-action-bar">
                <button class="vision-btn vision-btn-primary" onclick="evaluateWithIA()" style="flex: 1;">
                    üöÄ Analyser & D√©tecter
                </button>
                <button class="vision-btn vision-btn-secondary" onclick="clearIAForm()">
                    üóëÔ∏è Effacer
                </button>
            </div>

            <div id="iaAlert" class="alert-message"></div>
            <div id="iaResults" class="ia-results"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // ==================== LOAD USER STATS ====================

async function loadUserStats() {
    try {
        const response = await fetch('/api/get-user-data/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'include'
        });

        if (!response.ok) return;

        const data = await response.json();

        // ‚úÖ CALCULER totalHP en additionnant tous les traits HP
        let totalHP = 0;
        if (data.traitsHP) {
            Object.values(data.traitsHP).forEach(hp => {
                totalHP += hp;
            });
        }

        // Mettre √† jour les stats en haut de page
        const xpEl = document.querySelector('[data-stat="xp"]');
        const hpEl = document.querySelector('[data-stat="hp"]');
        const traitsEl = document.querySelector('[data-stat="traits"]');
        const levelEl = document.querySelector('[data-stat="level"]');

        if (xpEl) xpEl.textContent = data.totalXP || 0;
        if (hpEl) hpEl.textContent = totalHP;  // ‚úÖ UTILISE LE TOTAL CALCUL√â
        if (traitsEl) traitsEl.textContent = Object.keys(data.traitsHP || {}).length;
        if (levelEl) levelEl.textContent = data.level || 1;

    } catch (error) {
        console.error('Erreur chargement stats:', error);
    }
}


// ==================== INIT ====================

document.addEventListener('DOMContentLoaded', function() {
    renderDailyTasks();
    loadUserStats();  // ‚úÖ CHARGER LES STATS AU D√âMARRAGE
});

// ==================== SLEEP QUALITY SCALES (FROM IMAGES) ====================

// Bar√®me Qualit√© bas√© sur l'heure de coucher (CT = Coefficient de Temps)
const SLEEP_QUALITY_TIME_SCALE = {
    '20h-21h': { coefficient: 0.7, label: 'Tr√®s t√¥t' },
    '21h-22h': { coefficient: 1.0, label: 'Optimal' },
    '22h-23h': { coefficient: 0.95, label: 'Optimal' },
    '23h-0h': { coefficient: 0.8, label: 'Acceptable' },
    '0h-1h': { coefficient: 0.6, label: 'Tard' },
    '1h-2h': { coefficient: 0.4, label: 'Tr√®s tard' },
    '2h-3h': { coefficient: 0.2, label: 'Extr√™mement tard' },
    '3h+': { coefficient: 0.0, label: 'D√©calage majeur' }
};

// Bar√®me Quantit√© (CQ = Coefficient de Quantit√©)
const SLEEP_QUANTITY_SCALE = {
    '0-4': { coefficient: 0.1, label: 'Tr√®s insuffisant' },
    '4-5': { coefficient: 0.3, label: 'Insuffisant' },
    '5-6': { coefficient: 0.5, label: 'Limite basse' },
    '6-7': { coefficient: 0.7, label: 'En dessous de l\'optimal' },
    '7-8': { coefficient: 0.9, label: 'Bon' },
    '8-9': { coefficient: 1.0, label: 'Optimal' },
    '9-10': { coefficient: 0.7, label: 'L√©g√®rement excessif' },
    '10-11': { coefficient: 0.5, label: 'Excessif' },
    '11+': { coefficient: 0.3, label: 'Tr√®s excessif' }
};

// ==================== HP CALCULATION FORMULAS ====================

// Base HP pour un sommeil parfait (8-9h, coucher 21h-22h)
const BASE_SLEEP_HP = 200;
const BASE_NAP_HP = 50;

// Calculer les HP du sommeil en fonction du temps de coucher et de la dur√©e
function calculateSleepHP(bedTime, wakeTime) {
    if (!bedTime || !wakeTime) return 0;

    // Convertir les heures en minutes depuis minuit
    const [bedHour, bedMin] = bedTime.split(':').map(Number);
    const [wakeHour, wakeMin] = wakeTime.split(':').map(Number);

    let bedMinutes = bedHour * 60 + bedMin;
    let wakeMinutes = wakeHour * 60 + wakeMin;

    // Si l'heure de r√©veil est avant l'heure de coucher, on a dormi la nuit
    if (wakeMinutes <= bedMinutes) {
        wakeMinutes += 24 * 60; // Ajouter 24h
    }

    // Calculer la dur√©e totale de sommeil en heures
    const sleepDuration = (wakeMinutes - bedMinutes) / 60;

    // D√©terminer le coefficient de qualit√© (CT) bas√© sur l'heure de coucher
    let qualityCoef = 0;
    const bedHour24 = bedHour;

    if (bedHour24 >= 20 && bedHour24 < 21) {
        qualityCoef = SLEEP_QUALITY_TIME_SCALE['20h-21h'].coefficient;
    } else if (bedHour24 >= 21 && bedHour24 < 22) {
        qualityCoef = SLEEP_QUALITY_TIME_SCALE['21h-22h'].coefficient;
    } else if (bedHour24 >= 22 && bedHour24 < 23) {
        qualityCoef = SLEEP_QUALITY_TIME_SCALE['22h-23h'].coefficient;
    } else if (bedHour24 >= 23 || bedHour24 < 0) {
        qualityCoef = SLEEP_QUALITY_TIME_SCALE['23h-0h'].coefficient;
    } else if (bedHour24 >= 0 && bedHour24 < 1) {
        qualityCoef = SLEEP_QUALITY_TIME_SCALE['0h-1h'].coefficient;
    } else if (bedHour24 >= 1 && bedHour24 < 2) {
        qualityCoef = SLEEP_QUALITY_TIME_SCALE['1h-2h'].coefficient;
    } else if (bedHour24 >= 2 && bedHour24 < 3) {
        qualityCoef = SLEEP_QUALITY_TIME_SCALE['2h-3h'].coefficient;
    } else {
        qualityCoef = SLEEP_QUALITY_TIME_SCALE['3h+'].coefficient;
    }

    // D√©terminer le coefficient de quantit√© (CQ) bas√© sur la dur√©e
    let quantityCoef = 0;
    if (sleepDuration <= 4) {
        quantityCoef = SLEEP_QUANTITY_SCALE['0-4'].coefficient;
    } else if (sleepDuration <= 5) {
        quantityCoef = SLEEP_QUANTITY_SCALE['4-5'].coefficient;
    } else if (sleepDuration <= 6) {
        quantityCoef = SLEEP_QUANTITY_SCALE['5-6'].coefficient;
    } else if (sleepDuration <= 7) {
        quantityCoef = SLEEP_QUANTITY_SCALE['6-7'].coefficient;
    } else if (sleepDuration <= 8) {
        quantityCoef = SLEEP_QUANTITY_SCALE['7-8'].coefficient;
    } else if (sleepDuration <= 9) {
        quantityCoef = SLEEP_QUANTITY_SCALE['8-9'].coefficient;
    } else if (sleepDuration <= 10) {
        quantityCoef = SLEEP_QUANTITY_SCALE['9-10'].coefficient;
    } else if (sleepDuration <= 11) {
        quantityCoef = SLEEP_QUANTITY_SCALE['10-11'].coefficient;
    } else {
        quantityCoef = SLEEP_QUANTITY_SCALE['11+'].coefficient;
    }

    // Calculer les HP totaux: BASE_HP √ó CT √ó CQ
    const totalHP = BASE_SLEEP_HP * qualityCoef * quantityCoef;

    return Math.floor(totalHP);
}

// Calculer les HP de la sieste (bas√© uniquement sur la dur√©e)
function calculateNapHP(bedTime, wakeTime) {
    if (!bedTime || !wakeTime) return 0;

    const [bedHour, bedMin] = bedTime.split(':').map(Number);
    const [wakeHour, wakeMin] = wakeTime.split(':').map(Number);

    let bedMinutes = bedHour * 60 + bedMin;
    let wakeMinutes = wakeHour * 60 + wakeMin;

    // Pour une sieste, on assume que c'est dans la m√™me journ√©e
    if (wakeMinutes <= bedMinutes) {
        return 0; // Sieste invalide
    }

    const napDurationMinutes = wakeMinutes - bedMinutes;
    const napDurationHours = napDurationMinutes / 60;

    // Sieste optimale: 15-30 minutes
    // HP = BASE_NAP_HP pour 20 minutes, diminue si trop court ou trop long
    let napHP = 0;
    if (napDurationMinutes < 10) {
        napHP = BASE_NAP_HP * 0.2;
    } else if (napDurationMinutes <= 30) {
        napHP = BASE_NAP_HP * 1.0;
    } else if (napDurationMinutes <= 60) {
        napHP = BASE_NAP_HP * 0.8;
    } else if (napDurationMinutes <= 90) {
        napHP = BASE_NAP_HP * 0.6;
    } else {
        // Sieste trop longue
        napHP = BASE_NAP_HP * 0.3;
    }

    return Math.floor(napHP);
}

// ==================== TRAITS COMPLETS - 76 TRAITS ====================

const TRAITS_COMPLETS = {
  cognitive: [
    { name: "Pense Analytique", key: "analyticThinking", hpBase: 50, xpBase: 40 },
    { name: "Pense Logique", key: "logicalThinking", hpBase: 60, xpBase: 35 },
    { name: "Pense Critique", key: "criticalThinking", hpBase: 80, xpBase: 50 },
    { name: "Pense Strat√©gique", key: "strategicThinking", hpBase: 150, xpBase: 75 },
    { name: "Pense Syst√©mique", key: "systemicThinking", hpBase: 150, xpBase: 70 },
    { name: "Pense Abstraite", key: "abstractThinking", hpBase: 80, xpBase: 45 },
    { name: "Pense Intuitive", key: "intuitiveThinking", hpBase: 80, xpBase: 40 },
    { name: "Cr√©ativit√© Intellectuelle", key: "intellectualCreativity", hpBase: 100, xpBase: 80 },
    { name: "Curiosit√© Intellectuelle", key: "intellectualCuriosity", hpBase: 20, xpBase: 30 },
    { name: "Vision Long Terme", key: "longTermVision", hpBase: 100, xpBase: 60 },
    { name: "Flexibilit√© Mentale", key: "mentalFlexibility", hpBase: 80, xpBase: 50 },
    { name: "Rigidit√© Cognitive", key: "cognitiveRigidity", hpBase: -150, xpBase: -30, negative: true },
    { name: "Capacit√© d'Apprentissage", key: "learningCapacity", hpBase: 100, xpBase: 60 },
    { name: "Lucidit√©", key: "lucidity", hpBase: 80, xpBase: 45 },
    { name: "Esprit de Synth√®se", key: "syntheticMind", hpBase: 100, xpBase: 55 }
  ],
  emotional: [
    { name: "Stabilit√© √âmotionnelle", key: "emotionalStability", hpBase: 80, xpBase: 40 },
    { name: "Instabilit√© √âmotionnelle", key: "emotionalInstability", hpBase: -100, xpBase: -20, negative: true },
    { name: "R√©silience", key: "resilience", hpBase: 200, xpBase: 100 },
    { name: "Sang-Froid", key: "composure", hpBase: 150, xpBase: 80 },
    { name: "Sensibilit√© √âmotionnelle", key: "emotionalSensitivity", hpBase: 50, xpBase: 30 },
    { name: "Impulsivit√© √âmotionnelle", key: "emotionalImpulsivity", hpBase: -80, xpBase: -15, negative: true },
    { name: "Ma√Ætrise de Soi", key: "selfMastery", hpBase: 80, xpBase: 50 },
    { name: "Tol√©rance au Stress", key: "stressTolerance", hpBase: 80, xpBase: 50 },
    { name: "Vuln√©rabilit√© √âmotionnelle", key: "emotionalVulnerability", hpBase: 100, xpBase: 45 },
    { name: "Sto√Øcisme", key: "stoicism", hpBase: 80, xpBase: 40 },
    { name: "D√©tachement √âmotionnel", key: "emotionalDetachment", hpBase: 80, xpBase: 35 },
    { name: "Anxi√©t√©", key: "anxiety", hpBase: -80, xpBase: -15, negative: true },
    { name: "Irritabilit√©", key: "irritability", hpBase: -100, xpBase: -20, negative: true }
  ],
  behavioral: [
    { name: "Discipline", key: "discipline", hpBase: 30, xpBase: 35 },
    { name: "Autocontr√¥le", key: "selfControl", hpBase: 40, xpBase: 30 },
    { name: "Pers√©v√©rance", key: "perseverance", hpBase: 100, xpBase: 70 },
    { name: "Rigueur", key: "rigor", hpBase: 60, xpBase: 45 },
    { name: "Organisation", key: "organization", hpBase: 100, xpBase: 55 },
    { name: "Fiabilit√©", key: "reliability", hpBase: 80, xpBase: 50 },
    { name: "Sens du Devoir", key: "senseOfDuty", hpBase: 80, xpBase: 45 },
    { name: "Responsabilit√©", key: "accountability", hpBase: 100, xpBase: 60 },
    { name: "Prudence", key: "prudence", hpBase: 50, xpBase: 35 },
    { name: "Gestion du Temps", key: "timeManagement", hpBase: 80, xpBase: 45 },
    { name: "Capacit√© d'Ex√©cution", key: "executionCapacity", hpBase: 100, xpBase: 75 }
  ],
  social: [
    { name: "Sociabilit√©", key: "sociability", hpBase: 50, xpBase: 40 },
    { name: "Assertivit√©", key: "assertiveness", hpBase: 80, xpBase: 50 },
    { name: "Charisme", key: "charisma", hpBase: 100, xpBase: 70 },
    { name: "Influence", key: "influence", hpBase: 100, xpBase: 80 },
    { name: "Diplomatique", key: "diplomacy", hpBase: 100, xpBase: 60 },
    { name: "Coop√©ration", key: "cooperation", hpBase: 80, xpBase: 50 },
    { name: "Empathie Relationnelle", key: "relationalEmpathy", hpBase: 80, xpBase: 50 },
    { name: "Comp√©titivit√©", key: "competitiveness", hpBase: 80, xpBase: 60 },
    { name: "Individualisme", key: "individualism", hpBase: 100, xpBase: 55 },
    { name: "Dominance Sociale", key: "socialDominance", hpBase: 80, xpBase: 60 },
    { name: "Dominance Inverse", key: "inverseSocialDominance", hpBase: 100, xpBase: 50 },
    { name: "Ali√©nation Sociale", key: "socialAlienation", hpBase: -100, xpBase: -25, negative: true },
    { name: "Soumission Excessive", key: "excessiveSubmission", hpBase: -80, xpBase: -20, negative: true },
    { name: "Passivit√© Sociale", key: "socialPassivity", hpBase: -60, xpBase: -15, negative: true },
    { name: "Confiance Sociale", key: "socialTrust", hpBase: 100, xpBase: 60 }
  ],
  moral: [
    { name: "Int√©grit√© Intellectuelle", key: "intellectualIntegrity", hpBase: 26, xpBase: 40 },
    { name: "Loyaut√©", key: "loyalty", hpBase: 100, xpBase: 60 },
    { name: "Honneur", key: "honor", hpBase: 150, xpBase: 80 }
  ],
  learning: [
    { name: "Apprentissage", key: "learning", hpBase: 20, xpBase: 40 },
    { name: "Capacit√© d'Apprentissage", key: "learningAbility", hpBase: 100, xpBase: 80 },
    { name: "Expertise Reconnue", key: "recognizedExpertise", hpBase: 200, xpBase: 150 },
    { name: "Polyvalence", key: "versatility", hpBase: 300, xpBase: 120 }
  ],
  achievement: [
    { name: "Accomplissement", key: "accomplishment", hpBase: 40, xpBase: 60 },
    { name: "D√©termination", key: "determination", hpBase: 30, xpBase: 50 },
    { name: "Ambition", key: "ambition", hpBase: 50, xpBase: 70 },
    { name: "Innovation", key: "innovation", hpBase: 100, xpBase: 120 }
  ],
  existential: [
    { name: "Individualit√© Forte", key: "strongIndividuality", hpBase: 120, xpBase: 70 },
    { name: "Conscience de Soi", key: "selfAwareness", hpBase: 80, xpBase: 60 },
    { name: "Croissance Personnelle", key: "personalGrowth", hpBase: 100, xpBase: 80 },
    { name: "Sens & Purpose", key: "senseOfPurpose", hpBase: 150, xpBase: 100 }
  ],
  leadership: [
    { name: "Leadership Naturel", key: "naturalLeadership", hpBase: 100, xpBase: 90 },
    { name: "Vision Strat√©gique", key: "strategicVision", hpBase: 150, xpBase: 100 },
    { name: "Mentorat", key: "mentoring", hpBase: 100, xpBase: 100 },
    { name: "Cr√©ativit√© Organisationnelle", key: "organizationalCreativity", hpBase: 150, xpBase: 110 }
  ],
  affective: [
    { name: "Empathie √âmotionnelle", key: "emotionalEmpathy", hpBase: 80, xpBase: 50 },
    { name: "Compassion", key: "compassion", hpBase: 100, xpBase: 70 },
    { name: "Fiert√©", key: "pride", hpBase: 80, xpBase: 50 }
  ]
};

// ==================== ARTEFACTS KEYWORDS ====================

const ARTEFACTS_KEYWORDS = {
  booksRead: ["livre", "bouquin", "lu", "reading", "book"],
  academicArticles: ["article", "academic", "journal", "paper", "recherche", "√©tude"],
  projectsWorked: ["projet", "project", "github", "code", "d√©velopp√©", "cr√©√©"],
  onlineCourses: ["cours", "course", "formation", "training", "udemy", "coursera", "mooc"],
  socialContributions: ["contribution", "social", "community", "b√©n√©volat", "aide", "support"],
  networkingEvents: ["networking", "√©v√©nement", "conf√©rence", "meetup", "forum"]
};

// ==================== TRAIT DETECTION KEYWORDS ====================

const TRAIT_DETECTION_KEYWORDS = {
  analyticThinking: ["analyse", "donn√©es", "pattern", "dashboard", "pivot", "segmenter"],
  logicalThinking: ["logique", "argument", "raisonnement", "coherent"],
  criticalThinking: ["question", "critique", "challenge", "contredire"],
  strategicThinking: ["strat√©gie", "plan", "roadmap", "objectif"],
  systemicThinking: ["syst√®me", "architecture", "interconnexion"],
  abstractThinking: ["concept", "th√©orie", "abstrait", "framework"],
  intuitiveThinking: ["intuition", "instinct", "insight"],
  intellectualCreativity: ["cr√©ative", "innovation", "id√©e originale"],
  intellectualCuriosity: ["livre", "article", "exploration"],
  longTermVision: ["5 ans", "10 ans", "legacy"],
  mentalFlexibility: ["pivot", "adapter", "changement"],
  cognitiveRigidity: ["refuser", "blocage", "r√©sistance"],
  learningCapacity: ["certification", "skill", "ma√Ætrise"],
  lucidity: ["auto-√©valuation", "360", "feedback"],
  syntheticMind: ["r√©sum√©", "synth√®se", "documentation"],
  emotionalStability: ["calme", "serein", "compos√©"],
  emotionalInstability: ["fluctuation", "instable"],
  resilience: ["rebond", "surmont", "adversit√©"],
  composure: ["pression", "crise", "sang-froid"],
  emotionalSensitivity: ["empathie", "√©motion"],
  emotionalImpulsivity: ["impulsif", "regrett√©"],
  selfMastery: ["contr√¥le", "discipline"],
  stressTolerance: ["stress", "deadline"],
  emotionalVulnerability: ["vuln√©rable", "fragilit√©"],
  stoicism: ["sto√Øque", "acceptation"],
  emotionalDetachment: ["d√©tachement", "objectif"],
  anxiety: ["anxi√©t√©", "peur"],
  irritability: ["col√®re", "irritable"],
  discipline: ["routine", "objectif"],
  selfControl: ["contr√¥le", "impulse"],
  perseverance: ["obstacle", "persistent"],
  rigor: ["d√©tail", "standard", "qualit√©"],
  organization: ["syst√®me", "structure"],
  reliability: ["promesse", "deadline", "fiable"],
  senseOfDuty: ["devoir", "responsabilit√©"],
  accountability: ["erreur", "correction"],
  prudence: ["risque", "pr√©vention"],
  timeManagement: ["temps", "calendrier"],
  executionCapacity: ["projet livr√©", "ex√©cution"],
  sociability: ["social", "interaction", "networking"],
  assertiveness: ["limite", "frontalement"],
  charisma: ["captive", "inspirant"],
  influence: ["convaincu", "rallie"],
  diplomacy: ["conflit", "tactful"],
  cooperation: ["collaboratif", "synergy"],
  relationalEmpathy: ["soutien", "√©motion"],
  competitiveness: ["comp√©tition", "gagner"],
  individualism: ["unconventional", "unique"],
  socialDominance: ["leadership", "autorit√©"],
  inverseSocialDominance: ["modestie", "humble"],
  socialAlienation: ["isolement"],
  excessiveSubmission: ["soumis", "passif"],
  socialPassivity: ["retrait"],
  socialTrust: ["confiance", "loyaut√©"],
  intellectualIntegrity: ["transparence", "int√©grit√©"],
  loyalty: ["loyal", "d√©fendre"],
  honor: ["honneur", "dignit√©"],
  learning: ["livre lu", "article"],
  learningAbility: ["certification", "comp√©tence"],
  recognizedExpertise: ["expert", "sp√©cialiste"],
  versatility: ["multidisciplinaire", "polyvalent"],
  accomplishment: ["accomplissement", "r√©ussite"],
  determination: ["challenge", "impossible"],
  ambition: ["objectif majeur"],
  innovation: ["premi√®re", "produit lanc√©"],
  strongIndividuality: ["unique", "personnel"],
  selfAwareness: ["introspection", "shadow"],
  personalGrowth: ["transformation", "croissance"],
  senseOfPurpose: ["mission", "legacy"],
  naturalLeadership: ["leadership", "√©quipe suit"],
  strategicVision: ["vision", "plan ambitieux"],
  mentoring: ["mentor", "d√©velopp√©"],
  organizationalCreativity: ["culture", "processus innovant"],
  emotionalEmpathy: ["√©motion valid√©e", "support"],
  compassion: ["aide", "souffrance"],
  pride: ["fiert√©", "accompli"]
};

// ==================== ACTIVITY BAREME ====================

const ACTIVITY_BAREME_HP = {
    1: {
        name: 'Sommeil/Repos',
        emoji: 'üò¥',
        traits: [{ name: 'R√©silience', hp: 120 }, { name: 'Stabilit√© √âmotionnelle', hp: 80 }],
        usesTimeInputs: true,
        formula: calculateSleepHP
    },
    2: {
        name: 'Sieste',
        emoji: '‚è±Ô∏è',
        traits: [{ name: 'R√©silience', hp: 30 }],
        usesTimeInputs: true,
        formula: calculateNapHP
    },
    3: {
        name: 'Focus √âcole',
        emoji: 'üéØ',
        traits: [{ name: 'Discipline', hp: 80 }, { name: 'Capacit√© d\'Apprentissage', hp: 60 }],
        formula: (hours) => Math.floor(150 * hours)
    },
    4: {
        name: 'Retard √âcole/Travail',
        emoji: '‚è∞',
        traits: [{ name: 'Responsabilit√©', hp: -60 }, { name: 'Fiabilit√©', hp: -50 }],
        options: ['1 fois', '2 fois', '3+ fois'],
        hpPerQuality: { '1 fois': -50, '2 fois': -100, '3+ fois': -180 }
    },
    5: {
        name: 'Lecture',
        emoji: 'üìñ',
        traits: [{ name: 'Curiosit√© Intellectuelle', hp: 60 }, { name: 'Capacit√© d\'Apprentissage', hp: 50 }],
        options: ['Roman', '√âducation', 'Philosophie', 'D√©veloppement personnel'],
        formula: (hours, genre) => {
            const baseRate = { 'Roman': 40, '√âducation': 100, 'Philosophie': 80, 'D√©veloppement personnel': 70 };
            return Math.floor(baseRate[genre] * hours);
        }
    },
    6: {
        name: 'Sport/Exercice',
        emoji: 'üèÉ',
        traits: [{ name: 'Discipline', hp: 80 }, { name: 'R√©silience', hp: 50 }],
        options: ['Musculation', 'Cardio', 'Football', 'Basketball', 'Volley', 'Course', 'Natation', 'Tennis'],
        formula: (hours, type) => {
            const intensity = { 'Musculation': 1.3, 'Cardio': 1.2, 'Football': 1.4, 'Basketball': 1.4, 'Volley': 1.2, 'Course': 1.3, 'Natation': 1.3, 'Tennis': 1.3 };
            return Math.floor(100 * hours * (intensity[type] || 1.0));
        }
    },
    7: {
        name: 'Repas sain',
        emoji: 'üçΩÔ∏è',
        traits: [{ name: 'Discipline', hp: 50 }],
        options: ['Excellent', 'Bon', 'Moyen', 'Mauvais'],
        hpPerQuality: { 'Excellent': 150, 'Bon': 100, 'Moyen': 60, 'Mauvais': 20 }
    },
    8: {
        name: 'Hydratation',
        emoji: 'üíß',
        traits: [{ name: 'Discipline', hp: 30 }],
        options: ['Excellent', 'Bon', 'Moyen', 'Mauvais'],
        hpPerQuality: { 'Excellent': 80, 'Bon': 60, 'Moyen': 40, 'Mauvais': 20 }
    },
    9: {
        name: 'Procrastination',
        emoji: 'üì±',
        traits: [{ name: 'Discipline', hp: -40 }, { name: 'Gestion du Temps', hp: -30 }],
        formula: (hours) => Math.floor(-60 * hours)
    },
    10: {
        name: 'M√©ditation/Mindfulness',
        emoji: 'üßò',
        traits: [{ name: 'Stabilit√© √âmotionnelle', hp: 60 }, { name: 'Ma√Ætrise de Soi', hp: 50 }],
        formula: (hours) => Math.floor(100 * hours)
    }
};

// ==================== FUNCTIONS TO DETECT ARTEFACTS AND TRAITS ====================

function detectArtefactsFromDescription(description) {
  const artefacts = {
    booksRead: 0,
    academicArticles: 0,
    projectsWorked: 0,
    onlineCourses: 0,
    socialContributions: 0,
    networkingEvents: 0
  };

  const descLower = description.toLowerCase();

  for (let key in ARTEFACTS_KEYWORDS) {
    const keywords = ARTEFACTS_KEYWORDS[key];
    keywords.forEach(keyword => {
      const regex = new RegExp(`(\\d+)\\s*${keyword}`, 'gi');
      const matches = descLower.match(regex);
      if (matches) {
        matches.forEach(match => {
          const num = parseInt(match.match(/\d+/)[0]);
          artefacts[key] += num;
        });
      } else if (descLower.includes(keyword.toLowerCase())) {
        artefacts[key] += 1;
      }
    });
  }

  return artefacts;
}

function detectTraitsFromDescription(description) {
  const detectedTraits = [];
  const descLower = description.toLowerCase();

  const allTraits = [];
  Object.values(TRAITS_COMPLETS).forEach(category => {
    allTraits.push(...category);
  });

  allTraits.forEach(trait => {
    const keywordsList = TRAIT_DETECTION_KEYWORDS[trait.key] || [];
    const found = keywordsList.some(keyword => descLower.includes(keyword.toLowerCase()));

    if (found) {
      detectedTraits.push({
        name: trait.name,
        key: trait.key,
        hpAwarded: trait.hpBase,
        xpAwarded: trait.xpBase,
        negative: trait.negative || false
      });
    }
  });

  return detectedTraits;
}

// ==================== TAB SWITCHING ====================

function switchTab(event, tabName) {
    document.querySelectorAll('.vision-tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.vision-tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    document.getElementById(tabName).classList.add('active');
    event.currentTarget.classList.add('active');
}

// ==================== QUOTIDIEN FUNCTIONS ====================

function renderDailyTasks() {
    const table = document.getElementById('dailyTasksTable');
    if (!table) return;
    table.innerHTML = '';

    Object.entries(ACTIVITY_BAREME_HP).forEach(([id, activity]) => {
        const row = document.createElement('div');
        row.className = 'vision-task-row';

        let inputsHtml = '';

        // NEW: Handle time-based inputs for sleep and nap
        if (activity.usesTimeInputs) {
            inputsHtml = `
                <div class="sleep-time-inputs">
                    <span class="sleep-time-label">Coucher:</span>
                    <input type="time" class="sleep-time-input" id="activity${id}_bed" onchange="updateActivityPreview(${id})">
                    <span class="sleep-time-label">R√©veil:</span>
                    <input type="time" class="sleep-time-input" id="activity${id}_wake" onchange="updateActivityPreview(${id})">
                </div>
                <div class="hp-calc-display" id="preview${id}">+0 HP</div>
            `;
        } else if (activity.formula && !activity.hpPerQuality) {
            const options = activity.options ? activity.options.map(opt => `<option value="${opt}">${opt}</option>`).join('') : '';

            if (options) {
                inputsHtml = `
                    <div class="time-input-group">
                        <select class="vision-task-select" id="activity${id}_select" onchange="updateActivityPreview(${id})">
                            <option value="">S√©lectionner...</option>
                            ${options}
                        </select>
                        <input type="number" class="vision-task-input" id="activity${id}_duration" placeholder="0h" min="0" step="0.5" onchange="updateActivityPreview(${id})">
                        <span>h</span>
                    </div>
                    <div class="hp-calc-display" id="preview${id}">+0 HP</div>
                `;
            } else {
                inputsHtml = `
                    <div class="time-input-group">
                        <input type="number" class="vision-task-input" id="activity${id}_duration" placeholder="Heures" min="0" step="0.5" onchange="updateActivityPreview(${id})">
                        <span>h</span>
                    </div>
                    <div class="hp-calc-display" id="preview${id}">+0 HP</div>
                `;
            }
        } else if (activity.hpPerQuality) {
            const options = activity.options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
            inputsHtml = `
                <div class="time-input-group">
                    <select class="vision-task-select" id="activity${id}_select" onchange="updateActivityPreview(${id})">
                        <option value="">S√©lectionner...</option>
                        ${options}
                    </select>
                </div>
                <div class="hp-calc-display" id="preview${id}">+0 HP</div>
            `;
        }

        row.innerHTML = `
            <div class="vision-task-emoji">${activity.emoji}</div>
            <div class="vision-task-name">${activity.name}</div>
            <div class="vision-task-inputs">${inputsHtml}</div>
        `;

        table.appendChild(row);
    });
}

function updateActivityPreview(id) {
    const activity = ACTIVITY_BAREME_HP[id];
    let hp = 0;

    // NEW: Handle time-based inputs for sleep and nap
    if (activity.usesTimeInputs) {
        const bedTime = document.getElementById(`activity${id}_bed`)?.value;
        const wakeTime = document.getElementById(`activity${id}_wake`)?.value;

        if (bedTime && wakeTime) {
            hp = activity.formula(bedTime, wakeTime);
        }
    } else if (activity.formula && !activity.hpPerQuality) {
        const select = document.getElementById(`activity${id}_select`)?.value;
        const duration = parseFloat(document.getElementById(`activity${id}_duration`)?.value) || 0;

        if (duration > 0) {
            if (select) {
                hp = activity.formula(duration, select);
            } else if (!activity.options) {
                hp = activity.formula(duration);
            }
        }
    } else if (activity.hpPerQuality) {
        const select = document.getElementById(`activity${id}_select`)?.value;
        if (select) {
            hp = activity.hpPerQuality[select] || 0;
        }
    }

    const displayElement = document.getElementById(`preview${id}`);
    if (displayElement) {
        const displayHP = hp >= 0 ? `+${Math.floor(hp)} HP` : `${Math.floor(hp)} HP`;
        displayElement.textContent = displayHP;
        displayElement.classList.toggle('negative', hp < 0);
    }
}

// ‚úÖ UTILISE ENDPOINT: api/save-daily-activity/
async function submitDaily() {
    const activities_data = [];
    let totalHPGained = 0;

    Object.entries(ACTIVITY_BAREME_HP).forEach(([id, activity]) => {
        let hp = 0;
        let shouldAdd = false;
        let details = {};

        // NEW: Handle time-based inputs
        if (activity.usesTimeInputs) {
            const bedTime = document.getElementById(`activity${id}_bed`)?.value;
            const wakeTime = document.getElementById(`activity${id}_wake`)?.value;

            if (bedTime && wakeTime) {
                hp = activity.formula(bedTime, wakeTime);
                details = {
                    bed_time: bedTime,
                    wake_time: wakeTime
                };
                shouldAdd = true;
            }
        } else if (activity.formula && !activity.hpPerQuality) {
            const select = document.getElementById(`activity${id}_select`)?.value;
            const duration = parseFloat(document.getElementById(`activity${id}_duration`)?.value);

            if (duration && duration > 0) {
                if (select) {
                    hp = activity.formula(duration, select);
                    details = { type: select, duration: duration };
                } else if (!activity.options) {
                    hp = activity.formula(duration);
                    details = { duration: duration };
                }
                shouldAdd = true;
            }
        } else if (activity.hpPerQuality) {
            const select = document.getElementById(`activity${id}_select`)?.value;
            if (select) {
                hp = activity.hpPerQuality[select] || 0;
                details = { quality: select };
                shouldAdd = true;
            }
        }

        if (shouldAdd) {
            totalHPGained += hp;
            activities_data.push({
                id: parseInt(id),
                name: activity.name,
                hp: Math.floor(hp),
                traits: activity.traits || [],
                details: details
            });
        }
    });

    if (activities_data.length === 0) {
        showAlert('dailyAlert', 'Aucune activit√© saisie', 'error');
        return;
    }

    try {
        const response = await fetch('/api/save-daily-activity/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'include',
            body: JSON.stringify({
                activities: activities_data,
                totalHP: Math.floor(totalHPGained)
            })
        });

        if (response.ok) {
            showAlert('dailyAlert', `‚úÖ ${activities_data.length} activit√©(s) enregistr√©e(s) | Total: ${totalHPGained > 0 ? '+' : ''}${Math.floor(totalHPGained)} HP`, 'success');
            renderDailyTasks();
            loadUserStats(); // Reload stats after saving
        } else {
            showAlert('dailyAlert', 'Erreur lors de l\'enregistrement', 'error');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showAlert('dailyAlert', 'Impossible de communiquer avec le serveur', 'error');
    }
}

function clearAllDaily() {
    Object.keys(ACTIVITY_BAREME_HP).forEach(id => {
        const activity = ACTIVITY_BAREME_HP[id];

        if (activity.usesTimeInputs) {
            const bedEl = document.getElementById(`activity${id}_bed`);
            const wakeEl = document.getElementById(`activity${id}_wake`);
            if (bedEl) bedEl.value = '';
            if (wakeEl) wakeEl.value = '';
        } else {
            const selectEl = document.getElementById(`activity${id}_select`);
            const durationEl = document.getElementById(`activity${id}_duration`);
            if (selectEl) selectEl.value = '';
            if (durationEl) durationEl.value = '';
        }
        updateActivityPreview(id);
    });
    showAlert('dailyAlert', 'üîÑ Activit√©s r√©initialis√©es', 'info');
}

// ==================== IA FUNCTIONS ====================

// ‚úÖ √âTAPE 1: Appelle api/evaluate-activity/ - VERSION CORRIG√âE
// Cette fonction ANALYSE SEULEMENT, elle N'ENREGISTRE PAS en base de donn√©es
async function evaluateWithIA() {
    const description = document.getElementById('iaDescription').value.trim();

    if (!description || description.length < 50) {
        showAlert('iaAlert', 'D√©crivez votre activit√© en au moins 50 caract√®res', 'error');
        return;
    }

    const resultsDiv = document.getElementById('iaResults');
    resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analyse en cours...</p></div>';
    resultsDiv.classList.add('active');

    try {
        console.log('üì§ ENVOI POUR ANALYSE (PAS D\'ENREGISTREMENT)');
        console.log('   Description:', description.substring(0, 100) + '...');

        const evalResponse = await fetch('/api/evaluate-activity/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'include',
            body: JSON.stringify({ description: description })
        });

        if (!evalResponse.ok) {
            const errorData = await evalResponse.json();
            console.error('‚ùå Erreur serveur:', errorData);
            resultsDiv.innerHTML = '<div style="padding: 2rem; text-align: center; color: #999;">‚ö†Ô∏è Erreur lors de l\'analyse</div>';
            showAlert('iaAlert', errorData.error || 'Erreur lors de l\'analyse', 'error');
            return;
        }

        const evalData = await evalResponse.json();
        console.log('üì• R√âPONSE D\'ANALYSE (AUCUN ENREGISTREMENT EFFECTU√â):', evalData);

        if (!evalData.success) {
            showAlert('iaAlert', evalData.error || 'Erreur lors de l\'analyse', 'error');
            resultsDiv.classList.remove('active');
            return;
        }

        // ‚úÖ Stocker la r√©ponse pour l'enregistrement ult√©rieur
        // Utiliser les donn√©es retourn√©es par l'API (personality_traits d√©j√† en tableau)
        window.currentIAEvaluation = {
            xpTotal: evalData.total_xp || 0,
            qualityScore: evalData.quality_score || 0.8,
            feedback: evalData.feedback || 'Activit√© analys√©e avec succ√®s',
            traits: evalData.personality_traits || [],  // ‚Üê D√©j√† un tableau maintenant
            detections: evalData.detections || {},
            description: description
            // ‚ö†Ô∏è PAS d'evaluation_id car rien n'a √©t√© enregistr√©!
        };

        const data = window.currentIAEvaluation;
        let totalHP = 0;

        data.traits.forEach(trait => {
            totalHP += trait.hp_amount || 0;
        });

        console.log('‚úÖ Analyse termin√©e (AUCUN ENREGISTREMENT):');
        console.log('   XP:', data.xpTotal);
        console.log('   HP Total:', totalHP);
        console.log('   Traits:', data.traits.length);
        data.traits.forEach((t, i) => {
            console.log(`      ${i+1}. ${t.name} ‚Üí ${t.hp_amount} HP`);
        });
        console.log('   Art√©facts:', data.detections);

        // ‚úÖ AFFICHER LES R√âSULTATS (SANS AVOIR ENREGISTR√â)
        let html = `
        <div class="ia-result-section">
            <div class="ia-result-title">üéØ R√©sultats de l'Analyse</div>
            <div style="background: rgba(255, 152, 0, 0.1); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border-left: 3px solid #ff9800;">
                <div style="font-weight: 600; color: #ff9800; margin-bottom: 0.5rem;">‚ö†Ô∏è APER√áU SEULEMENT</div>
                <div style="color: var(--text-secondary); font-size: 0.9rem;">
                    Ces points ne sont PAS encore attribu√©s. Cliquez sur "Enregistrer l'√âvaluation" pour confirmer.
                </div>
            </div>
            <div class="xp-hp-grid">
                <div class="xp-hp-card xp">
                    <div class="xp-hp-label">XP Global</div>
                    <div class="xp-hp-value">${data.xpTotal}</div>
                </div>
                <div class="xp-hp-card hp">
                    <div class="xp-hp-label">HP Traits</div>
                    <div class="xp-hp-value">${totalHP >= 0 ? '+' : ''}${totalHP}</div>
                </div>
                <div class="xp-hp-card xp">
                    <div class="xp-hp-label">Qualit√©</div>
                    <div class="xp-hp-value">${(data.qualityScore * 100).toFixed(0)}%</div>
                </div>
            </div>

            <div style="background: rgba(6, 182, 212, 0.05); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; border-left: 3px solid rgba(33, 128, 141, 1);">
                <div style="font-weight: 600; color: rgba(33, 128, 141, 1); margin-bottom: 0.5rem;">üí¨ Feedback IA</div>
                <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6;">${data.feedback}</div>
            </div>

            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                <div class="ia-result-title">üì¶ Artefacts D√©tect√©s</div>
                <div class="detections-grid">
                    <div class="detection-card"><div class="detection-emoji">üìñ</div><div class="detection-label">Livres</div><div class="detection-value">${data.detections.booksRead || 0}</div></div>
                    <div class="detection-card"><div class="detection-emoji">üì∞</div><div class="detection-label">Articles</div><div class="detection-value">${data.detections.academicArticles || 0}</div></div>
                    <div class="detection-card"><div class="detection-emoji">üîß</div><div class="detection-label">Projets</div><div class="detection-value">${data.detections.projectsWorked || 0}</div></div>
                    <div class="detection-card"><div class="detection-emoji">üéì</div><div class="detection-label">Cours</div><div class="detection-value">${data.detections.onlineCourses || 0}</div></div>
                    <div class="detection-card"><div class="detection-emoji">ü§ù</div><div class="detection-label">Contributions</div><div class="detection-value">${data.detections.socialContributions || 0}</div></div>
                    <div class="detection-card"><div class="detection-emoji">üåê</div><div class="detection-label">Networking</div><div class="detection-value">${data.detections.networkingEvents || 0}</div></div>
                </div>
            </div>
        </div>`;

        if (data.traits && data.traits.length > 0) {
            html += `<div class="ia-result-section"><div class="ia-result-title">‚ú® Traits D√©tect√©s (${data.traits.length})</div><div class="trait-detection-grid">`;
            data.traits.forEach(trait => {
                const isNegative = trait.name.includes('N√©gatif') || trait.hp_amount < 0;
                html += `<div class="trait-detection-item${isNegative ? ' negative' : ''}">
                    <div class="trait-name">${isNegative ? '‚ö†Ô∏è' : '‚úì'} ${trait.name}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.4rem;">${trait.relevance || ''}</div>
                    <div class="trait-values">
                        <span class="trait-value hp">${trait.hp_amount >= 0 ? '+' : ''}${trait.hp_amount || 0}</span>
                    </div>
                </div>`;
            });
            html += `</div></div>`;
        }

        html += `<div class="ia-result-section">
            <button class="vision-btn vision-btn-success" onclick="saveIAEvaluation()">
                üíæ Enregistrer l'√âvaluation
            </button>
            <div style="margin-top: 0.75rem; text-align: center; color: var(--text-secondary); font-size: 0.85rem;">
                ‚ö†Ô∏è Cliquez pour confirmer et attribuer les points
            </div>
        </div>`;

        resultsDiv.innerHTML = html;

    } catch (error) {
        console.error('‚ùå ERREUR:', error);
        resultsDiv.innerHTML = '<div style="padding: 2rem; text-align: center; color: #999;">‚ùå Impossible de communiquer avec le serveur</div>';
        showAlert('iaAlert', 'Impossible de communiquer avec le serveur', 'error');
    }
}

// ‚úÖ √âTAPE 2: Appelle api/confirm-evaluation/ - VERSION CORRIG√âE
// Cette fonction ENREGISTRE les donn√©es en base de donn√©es
async function saveIAEvaluation() {
    const data = window.currentIAEvaluation;
    if (!data) {
        showAlert('iaAlert', 'Aucune √©valuation en attente', 'error');
        return;
    }

    try {
        console.log('üì§ ENVOI POUR ENREGISTREMENT EN BASE');
        console.log('   Description:', data.description.substring(0, 100) + '...');
        console.log('   XP Total:', data.xpTotal);
        console.log('   Traits:', data.traits.length);
        data.traits.forEach((trait, i) => {
            console.log(`      ${i+1}. ${trait.name} ‚Üí ${trait.hp_amount} HP`);
        });
        console.log('   Art√©facts:', data.detections);

        const confirmResponse = await fetch('/api/confirm-evaluation/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'include',
            body: JSON.stringify({
                description: data.description,
                xp_amount: data.xpTotal,
                quality_score: data.qualityScore,
                feedback: data.feedback,
                personality_traits: data.traits,  // ‚Üê D√©j√† au bon format
                detections: data.detections
            })
        });

        const result = await confirmResponse.json();
        console.log('üì• R√âPONSE D\'ENREGISTREMENT:', result);

        if (confirmResponse.ok) {
            let totalHP = 0;
            data.traits.forEach(t => totalHP += t.hp_amount || 0);
            
            let message = `‚úÖ √âvaluation enregistr√©e`;
            
            // Afficher les stats si disponibles
            if (result.traits_processed !== undefined) {
                message += ` | XP: ${result.xp_awarded} | HP: ${totalHP >= 0 ? '+' : ''}${totalHP}`;
                message += ` | Traits: ${result.traits_processed}/${result.total_traits}`;
                
                if (result.warnings && result.warnings.length > 0) {
                    message += ` (${result.warnings.length} avertissements)`;
                }
            } else {
                // Fallback si le serveur ne retourne pas de stats
                message += ` | XP: ${data.xpTotal} | HP: ${totalHP >= 0 ? '+' : ''}${totalHP}`;
            }
            
            showAlert('iaAlert', message, 'success');
            
            // Afficher les avertissements s'il y en a
            if (result.warnings && result.warnings.length > 0) {
                console.warn('‚ö†Ô∏è  AVERTISSEMENTS:', result.warnings);
            }
            
            // Afficher les art√©facts enregistr√©s
            if (result.artifacts_saved) {
                console.log('üì¶ ART√âFACTS ENREGISTR√âS:', result.artifacts_saved);
            }
            
            console.log('‚úÖ ENREGISTREMENT CONFIRM√â');
            console.log('   Evaluation ID:', result.evaluation_id);
            console.log('   Nouveau niveau:', result.new_level);
            
            clearIAForm();
            loadUserStats(); // Reload stats after saving
        } else {
            const errorMsg = result.error || 'Erreur inconnue';
            showAlert('iaAlert', `‚ùå ${errorMsg}`, 'error');
            console.error('‚ùå Erreur serveur:', result);
        }
    } catch (error) {
        console.error('‚ùå ERREUR CATCH:', error);
        showAlert('iaAlert', 'Impossible de communiquer avec le serveur', 'error');
    }
}

function clearIAForm() {
    document.getElementById('iaDescription').value = '';
    document.getElementById('iaResults').classList.remove('active');
    document.getElementById('iaResults').innerHTML = '';
    window.currentIAEvaluation = null;
}

// ==================== HELPERS ====================

function showAlert(elementId, message, type) {
    const alertEl = document.getElementById(elementId);
    if (!alertEl) return;

    alertEl.innerHTML = message;
    alertEl.className = `alert-message show ${type}`;

    setTimeout(() => {
        alertEl.classList.remove('show');
    }, 5000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ==================== INIT ====================

document.addEventListener('DOMContentLoaded', function() {
    renderDailyTasks();
});
</script>
{% endblock %}
