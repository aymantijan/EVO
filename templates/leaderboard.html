{% extends 'base.html' %}

{% block title %}Leaderboard - Classement Global{% endblock %}

{% block content %}
<div class="leaderboard-container">
    <!-- HEADER -->
    <div class="leaderboard-header">
        <div class="header-content">
            <h1>Classement Global</h1>
            <p>DÃ©couvrez les meilleurs joueurs et lÃ©gendes de la communautÃ©</p>
        </div>
    </div>

    <!-- TABS -->
    <div class="leaderboard-tabs">
        <button class="tab-btn active" data-tab="global">
            <span class="tab-text">Global</span>
        </button>
        <button class="tab-btn" data-tab="legends">
            <span class="tab-text">Universel</span>
        </button>
    </div>

    <!-- SEARCH & FILTER -->
    <div class="leaderboard-controls">
        <div class="search-box">
            <input type="text" id="search-input" placeholder="Chercher un joueur...">
            <span class="search-icon">R</span>
        </div>
    </div>

    <!-- YOUR RANK -->
    <div class="your-rank-card" id="your-rank-card">
        <div class="your-rank-content">
            <div class="your-rank-left">
                <div class="your-rank-badge">#<span id="your-rank-position">-</span></div>
                <div class="your-rank-info">
                    <div class="your-rank-label">Votre Classement</div>
                    <div class="your-rank-username" id="your-rank-username">Non connectÃ©</div>
                </div>
            </div>
            <div class="your-rank-middle">
                <div class="your-rank-stat">
                    <span class="stat-label">Niveau</span>
                    <span class="stat-value" id="your-rank-level">1</span>
                </div>
                <div class="your-rank-stat">
                    <span class="stat-label">Galaxie</span>
                    <span class="stat-value" id="your-rank-galaxy">Ã‰toile du Matin</span>
                </div>
                <div class="your-rank-stat">
                    <span class="stat-label">XP</span>
                    <span class="stat-value" id="your-rank-xp">0</span>
                </div>
            </div>
            <div class="your-rank-right">
                <div class="progress-label">Progression</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="your-rank-progress"></div>
                </div>
                <div class="progress-percent" id="your-rank-percentage">0%</div>
            </div>
        </div>
    </div>

    <!-- STATS -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-card-icon">P</div>
            <div class="stat-card-content">
                <div class="stat-card-label">Total</div>
                <div class="stat-card-value" id="total-players">0</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon">X</div>
            <div class="stat-card-content">
                <div class="stat-card-label">XP Moyen</div>
                <div class="stat-card-value" id="avg-xp">0</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon">L</div>
            <div class="stat-card-content">
                <div class="stat-card-label">Niveau Moyen</div>
                <div class="stat-card-value" id="avg-level">Lvl 1</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon">G</div>
            <div class="stat-card-content">
                <div class="stat-card-label">Galaxie Moyenne</div>
                <div class="stat-card-value" id="avg-galaxy">Ã‰toile du Matin</div>
            </div>
        </div>
    </div>

    <!-- LEADERBOARD TABLE -->
    <div class="leaderboard-table-section">
        <h2 class="section-title" id="table-title">Classement</h2>
        <div class="leaderboard-table-wrapper">
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th class="rank-col">Rang</th>
                        <th class="player-col">Joueur</th>
                        <th class="level-col">Niveau</th>
                        <th class="galaxy-col">Galaxie</th>
                        <th class="xp-col">XP</th>
                        <th class="action-col">Action</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-tbody">
                    <!-- Dynamique -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- PAGINATION -->
    <div class="pagination">
        <button class="btn-pagination" id="prev-page">Precedent</button>
        <span class="pagination-info">Page <span id="current-page">1</span> / <span id="total-pages">1</span></span>
        <button class="btn-pagination" id="next-page">Suivant</button>
    </div>
</div>

<!-- PROFILE MODAL -->
<div id="profile-modal-overlay" class="modal-overlay">
    <div class="modal-container">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-section">
                    <h2 id="modal-username" class="modal-username">Joueur</h2>
                    <span id="modal-legend-badge" class="modal-legend-badge"></span>
                </div>
                <button class="modal-close" onclick="closeProfileModal()">X</button>
            </div>

            <div class="modal-body">
                <div class="modal-stats-section">
                    <div class="modal-stat-box">
                        <span class="modal-stat-label">Niveau</span>
                        <span class="modal-stat-value" id="modal-level">1</span>
                    </div>
                    <div class="modal-stat-box">
                        <span class="modal-stat-label">Galaxie</span>
                        <span class="modal-stat-value" id="modal-galaxy">Ã‰toile du Matin</span>
                    </div>
                    <div class="modal-stat-box">
                        <span class="modal-stat-label">XP Total</span>
                        <span class="modal-stat-value" id="modal-xp">0</span>
                    </div>
                </div>

                <div class="modal-divider"></div>

                <div class="modal-description-section">
                    <h3 class="modal-description-title">A propos</h3>
                    <p id="modal-description" class="modal-description-text">Aucune description disponible</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* ==================== LAYOUT ====================*/
.leaderboard-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.leaderboard-header {
    text-align: center;
    margin-bottom: 40px;
    padding: 40px 20px;
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
    border-radius: 12px;
    color: white;
}

.leaderboard-header h1 {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 10px;
}

.leaderboard-header p {
    font-size: 1.1rem;
    opacity: 0.9;
}

/* ==================== TABS ====================*/
.leaderboard-tabs {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 15px;
    flex-wrap: wrap;
}

.tab-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--text-secondary);
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

.tab-btn:hover {
    color: var(--color-primary);
}

.tab-btn.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
}

/* ==================== CONTROLS ====================*/
.leaderboard-controls {
    display: flex;
    margin-bottom: 30px;
    gap: 15px;
}

.search-box {
    position: relative;
    flex: 1;
    max-width: 400px;
}

.search-box input {
    width: 100%;
    padding: 12px 15px 12px 40px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-size: 1rem;
    background: var(--color-surface);
    color: var(--text-primary);
    transition: border-color 0.3s ease;
}

.search-box input:focus {
    outline: none;
    border-color: var(--color-primary);
}

.search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.1rem;
    opacity: 0.6;
    font-weight: bold;
}

/* ==================== YOUR RANK ====================*/
.your-rank-card {
    background: var(--color-surface);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 40px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.your-rank-content {
    display: flex;
    align-items: center;
    gap: 30px;
}

.your-rank-left {
    display: flex;
    align-items: center;
    gap: 15px;
    min-width: 150px;
}

.your-rank-badge {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
    color: white;
    border-radius: 50%;
    font-size: 1.5rem;
    font-weight: bold;
}

.your-rank-info {
    display: flex;
    flex-direction: column;
}

.your-rank-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

.your-rank-username {
    font-size: 1.2rem;
    font-weight: bold;
    color: var(--text-primary);
}

.your-rank-middle {
    display: flex;
    gap: 40px;
    flex: 1;
}

.your-rank-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}

.stat-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

.stat-value {
    font-size: 1.3rem;
    font-weight: bold;
    color: var(--color-primary);
}

.your-rank-right {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    min-width: 150px;
}

.progress-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
    font-weight: 600;
}

.progress-bar {
    width: 150px;
    height: 8px;
    background: var(--border-color);
    border-radius: 10px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
    width: 0%;
    transition: width 0.5s ease;
}

.progress-percent {
    font-size: 0.9rem;
    font-weight: bold;
    color: var(--color-primary);
}

/* ==================== STATS GRID ====================*/
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 50px;
}

.stat-card {
    background: var(--color-surface);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    transition: all 0.3s ease;
}

.stat-card:hover {
    border-color: var(--color-primary);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.stat-card-icon {
    font-size: 2rem;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-primary);
    color: white;
    border-radius: 50%;
    font-weight: bold;
}

.stat-card-content {
    flex: 1;
}

.stat-card-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
    margin-bottom: 5px;
}

.stat-card-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--color-primary);
}

/* ==================== TABLE ====================*/
.leaderboard-table-section {
    margin-bottom: 40px;
}

.section-title {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 25px;
    color: var(--text-primary);
}

.leaderboard-table-wrapper {
    overflow-x: auto;
    border: 2px solid var(--border-color);
    border-radius: 12px;
}

.leaderboard-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--color-surface);
}

.leaderboard-table thead {
    background: var(--color-primary);
    color: white;
}

.leaderboard-table th {
    padding: 15px;
    text-align: left;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 0.5px;
}

.leaderboard-table td {
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-primary);
}

.leaderboard-table tbody tr {
    transition: all 0.3s ease;
}

.leaderboard-table tbody tr:hover {
    background: rgba(0, 0, 0, 0.02);
}

.leaderboard-table tbody tr.your-row {
    background: rgba(0, 0, 0, 0.05);
    border-left: 4px solid var(--color-primary);
}

.leaderboard-table tbody tr.legend-row {
    background: rgba(255, 193, 7, 0.05);
    border-left: 4px solid #FFD700;
}

.rank-col {
    width: 80px;
}

.rank-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
    color: white;
    border-radius: 50%;
    font-weight: bold;
    font-size: 0.95rem;
}

.rank-number.legend {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #333;
}

.player-col {
    flex: 1;
    min-width: 200px;
}

.player-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.player-avatar-mini {
    width: 40px;
    height: 40px;
    background: var(--color-primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    flex-shrink: 0;
    border: 2px solid var(--color-primary);
    overflow: hidden;
}

.player-avatar-mini img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

.player-avatar-mini.legend {
    border: 2px solid #FFD700;
}

.player-details {
    display: flex;
    flex-direction: column;
    gap: 3px;
}

.player-username {
    font-weight: 600;
    color: var(--text-primary);
}

.player-badge {
    display: inline-block;
    width: fit-content;
    padding: 2px 8px;
    background: var(--color-primary);
    color: white;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: bold;
    text-transform: uppercase;
}

.player-badge.legend {
    background: #FFD700;
    color: #333;
}

.player-badge.moroccan {
    background: #FF0000;
    color: white;
}

.level-col {
    width: 100px;
}

.level-badge {
    display: inline-block;
    padding: 6px 12px;
    background: rgba(0, 0, 0, 0.05);
    color: var(--color-primary);
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.9rem;
}

.galaxy-col {
    width: 200px;
}

.galaxy-badge {
    display: inline-block;
    padding: 6px 12px;
    background: rgba(0, 0, 0, 0.05);
    color: var(--color-secondary);
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.9rem;
}

.xp-col {
    width: 120px;
    text-align: right;
}

.xp-value {
    font-weight: 600;
    color: var(--color-primary);
    font-size: 1.1rem;
}

.action-col {
    width: 100px;
    text-align: center;
}

.btn-view-profile {
    padding: 8px 16px;
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.btn-view-profile:hover {
    background: var(--color-secondary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.btn-view-profile.legend {
    background: #FFD700;
    color: #333;
}

.btn-view-profile.legend:hover {
    background: #FFA500;
}

/* ==================== PAGINATION ====================*/
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    padding: 20px 0;
}

.btn-pagination {
    padding: 10px 20px;
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-pagination:hover:not(:disabled) {
    background: var(--color-secondary);
    transform: translateY(-2px);
}

.btn-pagination:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.pagination-info {
    color: var(--text-secondary);
    font-weight: 600;
}

/* ==================== MODAL ====================*/
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
}

.modal-overlay.active {
    display: flex;
}

.modal-container {
    width: 100%;
    display: flex;
    justify-content: center;
    padding: 20px;
}

.modal-content {
    background: var(--color-surface);
    border-radius: 16px;
    max-width: 600px;
    width: 100%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    overflow: hidden;
}

@keyframes slideUp {
    from {
        transform: translateY(40px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 30px;
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
    color: white;
    border-bottom: none;
}

.modal-title-section {
    display: flex;
    align-items: center;
    gap: 15px;
}

.modal-username {
    font-size: 1.8rem;
    font-weight: bold;
    margin: 0;
    color: white;
}

.modal-legend-badge {
    display: inline-block;
    padding: 6px 12px;
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid white;
    color: white;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.modal-close {
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid white;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 5px 12px;
    border-radius: 6px;
    transition: all 0.3s ease;
    font-weight: bold;
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

.modal-body {
    padding: 30px;
}

.modal-stats-section {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 30px;
}

.modal-stat-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    padding: 20px;
    background: var(--color-primary);
    border-radius: 12px;
    color: white;
    text-align: center;
}

.modal-stat-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 700;
    opacity: 0.9;
}

.modal-stat-value {
    font-size: 1.6rem;
    font-weight: bold;
}

.modal-divider {
    height: 2px;
    background: var(--border-color);
    margin: 20px 0;
}

.modal-description-section {
    background: rgba(0, 0, 0, 0.03);
    padding: 20px;
    border-radius: 12px;
}

.modal-description-title {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 700;
    color: var(--text-secondary);
    margin: 0 0 12px 0;
}

.modal-description-text {
    font-size: 1rem;
    line-height: 1.6;
    color: var(--text-primary);
    margin: 0;
    word-wrap: break-word;
}

/* ==================== RESPONSIVE ====================*/
@media (max-width: 768px) {
    .leaderboard-header {
        padding: 30px 15px;
    }

    .leaderboard-header h1 {
        font-size: 1.8rem;
    }

    .your-rank-content {
        flex-direction: column;
        gap: 20px;
    }

    .your-rank-middle {
        width: 100%;
        justify-content: space-around;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .leaderboard-table {
        font-size: 0.9rem;
    }

    .leaderboard-table th,
    .leaderboard-table td {
        padding: 10px;
    }

    .rank-col,
    .level-col,
    .xp-col,
    .action-col {
        width: auto;
    }

    .modal-stats-section {
        grid-template-columns: 1fr;
    }

    .modal-content {
        margin: 20px;
    }

    .modal-header {
        padding: 20px;
    }

    .modal-body {
        padding: 20px;
    }
}
</style>


<script>
    // ==================== CSRF TOKEN ====================

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    // ==================== CONFIGURATION ====================

    const ROWS_PER_PAGE = 20;
    const TOTAL_LEVELS = 1000;

    let currentPage = 1;
    let allPlayers = [];
    let allLegends = [];
    let filteredPlayers = [];
    let currentUser = null;
    let currentTab = 'global';

    // ==================== GALAXIES ====================
    const GALAXIES = {
        1: { name: 'Ã‰toile du Matin', color: '#10b981', min: 1, max: 100 },
        2: { name: 'AndromÃ¨de', color: '#06b6d4', min: 101, max: 200 },
        3: { name: 'Voie LactÃ©e', color: '#f59e0b', min: 201, max: 300 },
        4: { name: 'Sombrero', color: '#ec4899', min: 301, max: 400 },
        5: { name: 'Spirale du Cygne', color: '#8b5cf6', min: 401, max: 500 },
        6: { name: 'NÃ©buleuse du Crabe', color: '#ef4444', min: 501, max: 600 },
        7: { name: 'Galaxie d\'Orion', color: '#3b82f6', min: 601, max: 700 },
        8: { name: 'TrÃ©sor Cosmique', color: '#14b8a6', min: 701, max: 800 },
        9: { name: 'Paradis Stellaire', color: '#f97316', min: 801, max: 900 },
        10: { name: 'Univers SuprÃªme', color: '#6366f1', min: 901, max: 1000 },
    };

    function getGalaxyByLevel(level) {
        for (let i = 1; i <= 10; i++) {
            const g = GALAXIES[i];
            if (level >= g.min && level <= g.max) return g;
        }
        return GALAXIES[1];
    }

    // ==================== XP FORMULAS ====================
    function getXpForLevel(level) {
        return Math.floor((level * (level + 1) / 2) * 100);
    }

    function getTotalXpForLevel(level) {
        let total = 0;
        for (let i = 1; i <= level; i++) {
            total += getXpForLevel(i);
        }
        return total;
    }

    function calculateLevelFromXp(totalXp) {
        let level = 1;
        while (level < TOTAL_LEVELS) {
            if (getTotalXpForLevel(level + 1) > totalXp) {
                break;
            }
            level++;
        }
        return Math.min(level, TOTAL_LEVELS);
    }

    function getProgressToNextLevel(level, totalXp) {
        const totalXpForCurrent = getTotalXpForLevel(level);
        const totalXpForNext = getTotalXpForLevel(level + 1);
        if (totalXpForNext === totalXpForCurrent) return 100;
        const progress = ((totalXp - totalXpForCurrent) / (totalXpForNext - totalXpForCurrent)) * 100;
        return Math.min(100, Math.max(0, progress));
    }

    // ==================== LEGENDS DATA ====================
    const LEGENDS_BY_DOMAIN = {
        'science': [
            { name: 'Albert Einstein', xp: getTotalXpForLevel(900), description: 'Theorie de la relativite - Fondateur de la physique moderne', avatar: 'https://upload.wikimedia.org/wikipedia/commons/3/3e/Einstein_1921_by_F_Schmutzer.jpg' },
            { name: 'Marie Curie', xp: getTotalXpForLevel(895), description: '2x Prix Nobel - Decouvertes chimiques revolutionnaires', avatar: 'https://upload.wikimedia.org/wikipedia/commons/7/7e/Marie_Curie_c._1920s.jpg' },
            { name: 'Isaac Newton', xp: getTotalXpForLevel(890), description: 'Lois de la physique classique - Fondateur du calcul differentiel', avatar: 'https://upload.wikimedia.org/wikipedia/commons/3/39/GodfreyKneller-IsaacNewton-1689.jpg' }
        ],
        'tech': [
            { name: 'Steve Jobs', xp: getTotalXpForLevel(850), description: 'Fondateur d\'Apple - Revolution digitale', avatar: 'https://upload.wikimedia.org/wikipedia/commons/8/85/Steve_Jobs_2006-11-05.jpg' },
            { name: 'Bill Gates', xp: getTotalXpForLevel(840), description: 'Fondateur de Microsoft - Philanthrope mondial', avatar: 'https://upload.wikimedia.org/wikipedia/commons/a/ac/Bill_Gates_July_2015_cropped.jpg' },
            { name: 'Elon Musk', xp: getTotalXpForLevel(830), description: 'Tesla et SpaceX - Innovation technologique', avatar: 'https://upload.wikimedia.org/wikipedia/commons/3/34/Elon_Musk_Royal_Society.jpg' }
        ],
        'sports': [
            { name: 'Lionel Messi', xp: getTotalXpForLevel(765), description: '8 Ballons d\'Or - GOAT du football moderne', avatar: 'https://upload.wikimedia.org/wikipedia/commons/b/b4/Messi_vs_Almeria_2018.jpg' },
            { name: 'Cristiano Ronaldo', xp: getTotalXpForLevel(760), description: '5 Ballons d\'Or - Legende du football', avatar: 'https://upload.wikimedia.org/wikipedia/commons/d/d7/Cristiano_Ronaldo_2018_by_Glenn_Arthur.jpg' },
            { name: 'Michael Jordan', xp: getTotalXpForLevel(755), description: '6 fois champion NBA - GOAT du basketball', avatar: 'https://upload.wikimedia.org/wikipedia/commons/3/32/Michael_Jordan_2014.jpg' }
        ]
    };

    const MOROCCAN_LEGENDS = [
        { name: 'Hicham El Guerrouj', xp: getTotalXpForLevel(615), description: 'Champion d\'athletisme - Records du monde', avatar: 'https://upload.wikimedia.org/wikipedia/commons/f/f2/Hicham_El_Guerrouj_2008.jpg' },
        { name: 'Nawal El Moutawakel', xp: getTotalXpForLevel(610), description: 'Premier champion olympique marocain - Pionniere du sport', avatar: 'https://upload.wikimedia.org/wikipedia/commons/1/11/Nawal_El_Moutawakel.jpg' }
    ];

    // ==================== INITIALIZATION ====================

    async function initializeLeaderboard() {
        console.log('ðŸš€ Initialisation du leaderboard...');
        console.log('ðŸ”‘ CSRF Token:', csrftoken ? 'âœ… PrÃ©sent' : 'âŒ Manquant');

        const profileData = await getProfileData();
        if (profileData) {
            currentUser = mapPlayerData(profileData);
            console.log('âœ… Profil chargÃ©:', currentUser.username);
        }

        // CrÃ©er les lÃ©gendes
        allLegends = [];
        Object.values(LEGENDS_BY_DOMAIN).forEach(domain => {
            allLegends.push(...domain);
        });
        allLegends.push(...MOROCCAN_LEGENDS);
        allLegends.sort((a, b) => b.xp - a.xp);

        await loadLeaderboardTab('global');
    }

    async function loadLeaderboardTab(tabType) {
        currentTab = tabType;
        currentPage = 1;

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.tab === tabType) {
                btn.classList.add('active');
            }
        });

        if (tabType === 'legends') {
            document.getElementById('table-title').textContent = 'Classement Universel (Joueurs + LÃ©gendes)';

            // Charger les joueurs
            const leaderboardData = await getLeaderboardData('global');
            if (leaderboardData && leaderboardData.length > 0) {
                allPlayers = leaderboardData.map(p => mapPlayerData(p));
            } else {
                allPlayers = [];
            }

            // Fusionner joueurs et lÃ©gendes
            const combinedList = [];

            // Ajouter les joueurs
            allPlayers.forEach(player => {
                combinedList.push({
                    ...player,
                    isLegend: false
                });
            });

            // Ajouter les lÃ©gendes
            allLegends.forEach(legend => {
                combinedList.push({
                    id: 'legend_' + legend.name,
                    username: legend.name,
                    total_xp: legend.xp,
                    level: calculateLevelFromXp(legend.xp),
                    galaxy: getGalaxyByLevel(calculateLevelFromXp(legend.xp)),
                    isLegend: true,
                    description: legend.description,
                    profile_image_url: legend.avatar,
                    isMoroccan: MOROCCAN_LEGENDS.some(m => m.name === legend.name)
                });
            });

            // Trier par XP (descendant)
            combinedList.sort((a, b) => {
                return b.total_xp - a.total_xp;
            });

            filteredPlayers = combinedList;
        } else {
            document.getElementById('table-title').textContent = 'Classement';
            console.log('ðŸ“Š Chargement leaderboard ' + tabType + '...');
            const leaderboardData = await getLeaderboardData(tabType);

            if (leaderboardData && leaderboardData.length > 0) {
                allPlayers = leaderboardData.map(p => mapPlayerData(p));
                allPlayers.sort((a, b) => b.total_xp - a.total_xp);
                allPlayers.forEach((player, index) => {
                    player.rank = index + 1;
                });
                console.log('âœ… Joueurs chargÃ©s: ' + allPlayers.length);
            } else {
                allPlayers = [];
            }

            filteredPlayers = [...allPlayers];
        }

        renderLeaderboard();
        renderYourRank();
        renderStats();
    }

    // ==================== API CALLS ====================

    async function getProfileData() {
        try {
            const response = await fetch('/api/get-user-data/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                credentials: 'include'
            });

            if (!response.ok) throw new Error('Erreur API');

            const data = await response.json();
            return {
                user_id: data.user?.id || 1,
                username: data.user?.username || 'Utilisateur',
                level: calculateLevelFromXp(data.totalXP || 0),
                total_xp: data.totalXP || 0,
                traitsHP: data.traitsHP || {},
                id: data.user?.id || 1,
                profile_image_url: data.profile_image_url || null
            };
        } catch (error) {
            console.error('âŒ Erreur profil:', error);
            return null;
        }
    }

    async function getLeaderboardData(type = 'global') {
        try {
            let endpoint = '/api/leaderboard/';
            if (type === 'weekly') {
                endpoint = '/api/leaderboard-weekly/';
            } else if (type === 'monthly') {
                endpoint = '/api/leaderboard-monthly/';
            }

            const response = await fetch(endpoint, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                credentials: 'include'
            });

            if (!response.ok) throw new Error('Erreur API leaderboard');

            const data = await response.json();
            console.log('âœ… API Response:', data);
            return Array.isArray(data) ? data : (data.data || []);
        } catch (error) {
            console.error('âŒ Erreur leaderboard:', error);
            return [];
        }
    }

    // ==================== DATA MAPPING ====================

    function mapPlayerData(player) {
        const totalXp = player.experience_points || player.total_points || player.total_xp || 0;
        const level = calculateLevelFromXp(totalXp);
        const galaxy = getGalaxyByLevel(level);

        return {
            id: player.user_id || player.id || 0,
            username: player.username || 'Joueur',
            total_xp: totalXp,
            level: level,
            galaxy: galaxy,
            rank: player.rank || 0,
            isLegend: false,
            profile_image_url: player.profile_image_url || null
        };
    }

    // ==================== GENERATE AVATAR FALLBACK ====================

    function getAvatarUrl(player) {
        if (player.profile_image_url) {
            return player.profile_image_url;
        }
        // GÃ©nÃ¨re un avatar avec UI Avatars
        return `https://ui-avatars.com/api/?name=${encodeURIComponent(player.username)}&background=random&color=fff&size=128`;
    }

    // ==================== RENDER YOUR RANK ====================

    function renderYourRank() {
        if (!currentUser) {
            document.getElementById('your-rank-username').textContent = 'Non connectÃ©';
            document.getElementById('your-rank-position').textContent = '-';
            return;
        }

        if (currentTab === 'legends') {
            document.getElementById('your-rank-card').style.display = 'block';
            const yourRank = filteredPlayers.findIndex(p => !p.isLegend && p.id === currentUser.id) + 1;
            if (yourRank > 0) {
                document.getElementById('your-rank-position').textContent = yourRank;
            } else {
                document.getElementById('your-rank-position').textContent = '-';
            }
        } else {
            document.getElementById('your-rank-card').style.display = 'block';
            const yourRank = allPlayers.findIndex(p => p.id === currentUser.id) + 1 || allPlayers.length + 1;
            document.getElementById('your-rank-position').textContent = yourRank;
        }

        const galaxy = currentUser.galaxy;

        document.getElementById('your-rank-username').textContent = currentUser.username;
        document.getElementById('your-rank-xp').textContent = Math.floor(currentUser.total_xp).toLocaleString('fr-FR');
        document.getElementById('your-rank-level').textContent = currentUser.level;

        const galaxyElement = document.getElementById('your-rank-galaxy');
        if (galaxyElement) {
            galaxyElement.textContent = galaxy.name;
            galaxyElement.style.color = galaxy.color;
        }

        const progress = getProgressToNextLevel(currentUser.level, currentUser.total_xp);
        document.getElementById('your-rank-progress').style.width = progress + '%';
        document.getElementById('your-rank-percentage').textContent = Math.floor(progress) + '%';
    }

    // ==================== RENDER LEADERBOARD WITH PHOTOS ====================

    function renderLeaderboard() {
        const start = (currentPage - 1) * ROWS_PER_PAGE;
        const end = start + ROWS_PER_PAGE;

        let pageData = filteredPlayers.slice(start, end);
        const tbody = document.getElementById('leaderboard-tbody');

        if (filteredPlayers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-secondary);">Aucun joueur au classement pour le moment</td></tr>';
            return;
        }

        tbody.innerHTML = pageData.map((player, idx) => {
            const rankNumber = start + idx + 1;
            const isYourRow = currentUser && !player.isLegend && player.id === currentUser.id;
            const isLegend = player.isLegend;

            // âœ… UTILISER LA PHOTO DU JOUEUR
            const photoUrl = getAvatarUrl(player);

            return `
                <tr ${isYourRow ? 'class="your-row"' : (isLegend ? 'class="legend-row"' : '')}>
                    <td class="rank-col">
                        <div class="rank-number ${isLegend ? 'legend' : ''}">
                            ${rankNumber}
                        </div>
                    </td>
                    <td class="player-col">
                        <div class="player-info">
                            <div class="player-avatar-mini ${isLegend ? 'legend' : ''}">
                                <img src="${photoUrl}" alt="${player.username}" class="player-avatar-img" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(player.username)}&background=random&color=fff&size=128'">
                            </div>
                            <div class="player-details">
                                <div class="player-username">${player.username}</div>
                                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                    ${isYourRow ? '<div class="player-badge">Vous</div>' : ''}
                                    ${isLegend ? '<div class="player-badge legend">LÃ©gende</div>' : ''}
                                    ${player.isMoroccan ? '<div class="player-badge moroccan">ðŸ‡²ðŸ‡¦ MAR</div>' : ''}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="level-col">
                        <div class="level-badge">Lvl ${player.level}</div>
                    </td>
                    <td class="galaxy-col">
                        <div class="galaxy-badge" style="color: ${player.galaxy.color};">
                            ${player.galaxy.name}
                        </div>
                    </td>
                    <td class="xp-col">
                        <div class="xp-value">${Math.floor(player.total_xp).toLocaleString('fr-FR')}</div>
                    </td>
                    <td class="action-col">
                        <button class="btn-view-profile ${isLegend ? 'legend' : ''}" onclick="openProfileModal('${player.username.replace(/'/g, "\\'")}', ${player.level}, ${Math.floor(player.total_xp)}, '${player.galaxy.name}', '${(player.description || '').replace(/'/g, "\\'")}')" style="white-space: nowrap;">
                            Voir
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        const totalPages = Math.ceil(filteredPlayers.length / ROWS_PER_PAGE);
        document.getElementById('current-page').textContent = currentPage;
        document.getElementById('total-pages').textContent = totalPages;
        document.getElementById('prev-page').disabled = currentPage === 1;
        document.getElementById('next-page').disabled = currentPage === totalPages;

        console.log(`âœ… ${pageData.length} joueurs rendus (page ${currentPage}/${totalPages})`);
    }

    // ==================== RENDER STATS ====================

    function renderStats() {
        if (filteredPlayers.length === 0) {
            document.getElementById('total-players').textContent = '0';
            document.getElementById('avg-xp').textContent = '0';
            document.getElementById('avg-level').textContent = 'Lvl 0';
            document.getElementById('avg-galaxy').textContent = 'N/A';
            return;
        }

        const totalPlayers = filteredPlayers.length;
        const avgXp = Math.floor(filteredPlayers.reduce((sum, p) => sum + p.total_xp, 0) / totalPlayers);
        const avgLevel = Math.floor(filteredPlayers.reduce((sum, p) => sum + p.level, 0) / totalPlayers);
        const topGalaxy = getGalaxyByLevel(avgLevel);

        document.getElementById('total-players').textContent = totalPlayers.toLocaleString('fr-FR');
        document.getElementById('avg-xp').textContent = avgXp.toLocaleString('fr-FR');
        document.getElementById('avg-level').textContent = 'Lvl ' + avgLevel;

        const galaxyElement = document.getElementById('avg-galaxy');
        if (galaxyElement) {
            galaxyElement.textContent = topGalaxy.name;
            galaxyElement.style.color = topGalaxy.color;
        }
    }

    // ==================== MODAL ====================

    function openProfileModal(username, level, xp, galaxyName, description) {
        const modal = document.getElementById('profile-modal-overlay');
        const galaxy = getGalaxyByLevel(level);

        document.getElementById('modal-username').textContent = username;
        document.getElementById('modal-level').textContent = 'Lvl ' + level;
        document.getElementById('modal-xp').textContent = xp.toLocaleString('fr-FR');
        document.getElementById('modal-galaxy').textContent = galaxy.name;
        document.getElementById('modal-galaxy').style.color = galaxy.color;

        const descElement = document.getElementById('modal-description');

        if (description && description.trim()) {
            descElement.textContent = description;
        } else {
            descElement.textContent = 'Aucune description disponible';
        }

        modal.classList.add('active');
    }

    function closeProfileModal() {
        const modal = document.getElementById('profile-modal-overlay');
        modal.classList.remove('active');
    }

    // ==================== EVENT LISTENERS ====================

    document.getElementById('prev-page')?.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            renderLeaderboard();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    });

    document.getElementById('next-page')?.addEventListener('click', () => {
        const totalPages = Math.ceil(filteredPlayers.length / ROWS_PER_PAGE);
        if (currentPage < totalPages) {
            currentPage++;
            renderLeaderboard();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    });

    document.getElementById('search-input')?.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();

        if (currentTab === 'legends') {
            filteredPlayers = filteredPlayers.sort((a, b) => b.total_xp - a.total_xp)
                .filter(p => p.username.toLowerCase().includes(query));
        } else {
            filteredPlayers = allPlayers.filter(p => p.username.toLowerCase().includes(query));
        }

        currentPage = 1;
        renderLeaderboard();
    });

    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tabType = this.dataset.tab || 'global';
            loadLeaderboardTab(tabType);
        });
    });

    document.getElementById('profile-modal-overlay')?.addEventListener('click', (e) => {
        if (e.target.id === 'profile-modal-overlay') {
            closeProfileModal();
        }
    });

    // ==================== INITIALIZATION ====================

    document.addEventListener('DOMContentLoaded', initializeLeaderboard);

    // ==================== AUTO-REFRESH ====================

    setInterval(() => {
        console.log('ðŸ”„ Actualisation du leaderboard...');
        if (currentTab !== 'legends') {
            loadLeaderboardTab(currentTab);
        }
    }, 30000);

</script>


{% endblock %}
